<tool id="kmetashot" name="kMetaShot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>an alignment-free taxonomic classifier based on k-mer/minimizer counting</description>
    <macros>
        <token name="@TOOL_VERSION@">2.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">25.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kmetashot</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[
        mkdir -p output bins &&

        #if $bins_input.input_type == "collection":
            #for $file in $bins_input.bins_dir:
                ln -s '$file' 'bins/$file.element_identifier.$file.extension' &&
            #end for
        #else:
            ln -s '$bins_input.bin_file' 'bins/$bins_input.bin_file.element_identifier.$bins_input.bin_file.extension' &&
        #end if

        ls -la bins &&

        kMetaShot_classifier_NV.py 
            -b bins 
            -o output 
            -r '$reference.fields.path' 
            -p 1 
            -a ${ass2ref}
    ]]>
    </command>
    <inputs>
        <conditional name="bins_input">
            <param name="input_type"
                type="select"
                label="Input type">
                <option value="collection">Collection of bins</option>
                <option value="single">Single bin</option>
            </param>

            <when value="collection">
                <param name="bins_dir"
                    type="data_collection"
                    collection_type="list"
                    format="fasta,fasta.gz"
                    label="Bin(s)/MAG(s) fasta files"/>
            </when>

            <when value="single">
                <param name="bin_file"
                    type="data"
                    format="fasta,fasta.gz"
                    label="Bin/MAG fasta file"/>
            </when>
        </conditional> 
        <param argument="--reference" type="select" label="Select a reference database.">
            <options from_data_table="kmetashot">
                <filter type="sort_by" column="2"/>
            </options>
            <validator type="no_options" message="No reference data for kMetaShot is installed. Please contact the Galaxy adminstrators to request one be installed."/>
        </param>
        <param argument="--ass2ref" type="float" min="0.0" value="0.0" max="1.0" label="Set ass2ref parameter" help="Ass2ref is a ratio between the number of MAG minimizers and the reference minimizers related to the assigned strain"/>
    </inputs>
    <outputs>
        <data name="result"
            format="tabular"
            label="${tool.name} on ${on_string}: Taxonomic Classification"
            from_work_dir="output/kMetaShot_classification_resume.csv" />
    </outputs>
    <tests>

        <!-- The tool needs a 20 gb ref. DB and at leatst 40gb memory, so tests
        need to be done locally -->
        <test expect_num_outputs="1">
            <param name="bins_dir" value="all_contig.fasta.gz" ftype="fasta.gz"/>
	    <param name="ass2ref" value="0.0"/>
	    <param name="reference" value="25-05-22"/>
        <output name="result" file="kMetaShot_classification_a0.0.csv">
        </test>
        <test expect_num_outputs="1">
            <param name="bins_dir" value="all_contig.fasta.gz" ftype="fasta.gz"/>
	    <param name="ass2ref" value="0.2"/>
	    <param name="reference" value="25-05-22"/>
        <output name="result" file="kMetaShot_classification_a0.2.csv">
        </test>
    </tests>
    <help>
        <![CDATA[
        
            This tool is a taxonomic classifier which used a new algorithm which is alignment free.
            The data from the input files will be transformed into bites and each base is represented by 2 bites.

            A = 00
            C = 01
            G = 10
            T = 11

            Therefore the reference which was build for this can used this transformed data and match them to create a classification for the bin(s)/MAG(s).

            **Input**

            Fasta file(s) in fasta format or/and fasta.gz format (.fa, .fasta, .fna, .fa.gz, .fasta.gz, .fna.gz are allowed extensions)

            **Reference**

            The reference data needed for this tool is provided from a data manager which always installed the latest version of the data

            **Output**

            The Output is a collection with csv file(s) which contained the classification for the inputted bin(s)/MAG(s) 

        ]]>
    </help>  
    <citations>
        <citation type="doi">10.1093/bib/bbae680</citation>
    </citations>
</tool>
